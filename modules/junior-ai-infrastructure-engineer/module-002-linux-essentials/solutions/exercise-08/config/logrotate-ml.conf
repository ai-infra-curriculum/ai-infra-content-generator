# ML Infrastructure Log Rotation Configuration
#
# Installation:
#   sudo cp logrotate-ml.conf /etc/logrotate.d/ml-infrastructure
#   sudo logrotate -d /etc/logrotate.d/ml-infrastructure  # Test configuration
#   sudo logrotate -f /etc/logrotate.d/ml-infrastructure  # Force rotation (testing)
#
# Logrotate runs daily via /etc/cron.daily/logrotate

###############################################################################
# ML Application Logs
###############################################################################

/var/log/ml-api/*.log {
    # Rotate daily
    daily

    # Keep 14 days of logs
    rotate 14

    # Compress old logs
    compress

    # Delay compression until next rotation (allows time for log analysis)
    delaycompress

    # Don't error if log file is missing
    missingok

    # Don't rotate if log is empty
    notifempty

    # Create new log file with these permissions
    create 0640 mluser mluser

    # Use date as suffix (e.g., logfile-20250131.gz)
    dateext
    dateformat -%Y%m%d

    # Share scripts between all log files
    sharedscripts

    # Run after rotation (reload application to use new log file)
    postrotate
        # Send HUP signal to reload (adjust service name as needed)
        systemctl reload ml-api.service > /dev/null 2>&1 || true

        # Or kill -HUP $(cat /var/run/ml-api.pid) || true
    endscript
}

###############################################################################
# ML Training Logs
###############################################################################

/var/log/ml-training/*.log {
    # Rotate weekly
    weekly

    # Keep 8 weeks of logs
    rotate 8

    # Compress old logs
    compress
    delaycompress

    # Don't error if missing
    missingok
    notifempty

    # Also rotate if log exceeds 100MB (even if not weekly yet)
    size 100M

    # Create with permissions
    create 0640 mluser mluser

    # Date extension
    dateext

    sharedscripts

    # No postrotate needed (training jobs write to new files)
}

###############################################################################
# Model Backup Logs
###############################################################################

/var/log/ml-backup.log {
    # Rotate daily
    daily

    # Keep 30 days
    rotate 30

    # Compress
    compress
    delaycompress

    missingok
    notifempty

    # Smaller log files, use simple numbering
    # create numbered backups: ml-backup.log.1, ml-backup.log.2.gz, etc.

    create 0644 root root

    # No postrotate needed
}

###############################################################################
# GPU Monitoring Logs
###############################################################################

/var/log/gpu-monitor.log {
    # Rotate daily
    daily

    # Keep 30 days (useful for historical analysis)
    rotate 30

    compress
    delaycompress

    missingok
    notifempty

    create 0644 root root

    # Copy and truncate (monitoring script keeps file open)
    copytruncate

    # Don't rotate if smaller than 10KB (avoid rotating empty logs)
    minsize 10K
}

###############################################################################
# GPU Metrics CSV
###############################################################################

/var/log/gpu-metrics.csv {
    # Rotate weekly
    weekly

    # Keep 12 weeks (3 months of historical data)
    rotate 12

    compress
    delaycompress

    missingok
    notifempty

    # Don't compress CSV (easier to analyze)
    nocompress

    create 0644 root root

    # Copy and truncate (monitoring script appends)
    copytruncate

    # Only rotate if larger than 5MB
    minsize 5M

    # After rotation, optionally import to database
    postrotate
        # Example: Import to database for long-term storage
        # /home/mluser/scripts/import_gpu_metrics.sh /var/log/gpu-metrics.csv.1 || true
    endscript
}

###############################################################################
# Cleanup Logs
###############################################################################

/var/log/ml-cleanup.log {
    # Rotate weekly
    weekly

    # Keep 8 weeks
    rotate 8

    compress
    delaycompress

    missingok
    notifempty

    create 0644 root root
}

###############################################################################
# Health Check Logs
###############################################################################

/var/log/ml-health-check.log {
    # Rotate daily
    daily

    # Keep 14 days
    rotate 14

    compress
    delaycompress

    missingok
    notifempty

    create 0644 root root

    copytruncate
}

###############################################################################
# Maintenance Suite Log
###############################################################################

/var/log/ml-maintenance.log {
    # Rotate monthly
    monthly

    # Keep 12 months
    rotate 12

    compress
    delaycompress

    missingok
    notifempty

    create 0644 root root

    dateext
    dateformat -%Y%m

    # Archive old logs to long-term storage
    lastaction
        # Example: Archive to S3
        # aws s3 cp /var/log/ml-maintenance.log.*.gz s3://my-logs/maintenance/ || true
    endscript
}

###############################################################################
# Wildcard for All ML Logs
###############################################################################

# Catch-all for any other ML logs
/opt/ml/logs/*.log {
    weekly
    rotate 4
    compress
    delaycompress
    missingok
    notifempty
    create 0640 mluser mluser
    sharedscripts
}

###############################################################################
# Logrotate Directives Reference
###############################################################################
#
# Frequency:
#   daily, weekly, monthly, yearly
#
# Rotation:
#   rotate N              - Keep N old log files
#   size N[K|M|G]         - Rotate if larger than size
#   minsize N[K|M|G]      - Minimum size before rotation
#   maxsize N[K|M|G]      - Force rotation if exceeds size
#   maxage N              - Remove logs older than N days
#
# Compression:
#   compress              - Compress old logs with gzip
#   nocompress            - Don't compress
#   delaycompress         - Compress on next rotation (keep most recent uncompressed)
#   compresscmd PROG      - Use different compression (e.g., bzip2, xz)
#   compressext EXT       - Compression file extension
#   compressoptions OPTS  - Options for compression program
#
# Naming:
#   dateext               - Use date as extension
#   dateformat STRING     - Date format (must include %Y %m %d)
#   nodateext             - Use numbers instead of dates
#
# File Handling:
#   copytruncate          - Copy log then truncate (for always-open files)
#   create MODE USER GROUP - Create new log file with permissions
#   nocreate              - Don't create new log file
#   missingok             - Don't error if log is missing
#   notifempty            - Don't rotate if log is empty
#   ifempty               - Rotate even if empty
#
# Scripts:
#   prerotate/endscript   - Run before rotation
#   postrotate/endscript  - Run after rotation
#   firstaction/endscript - Run once before all logs rotated
#   lastaction/endscript  - Run once after all logs rotated
#   sharedscripts         - Run scripts once for all logs (not per log)
#
# Special:
#   olddir DIRECTORY      - Move old logs to directory
#   noolddir              - Keep old logs in same directory
#   mail ADDRESS          - Email old logs before deleting
#   mailfirst             - Email newest log (not oldest)
#   maillast              - Email oldest log (default)
#   extension EXT         - Only rotate files with extension
#   addextension EXT      - Append extension after date
#
###############################################################################
# Testing and Debugging
###############################################################################
#
# Test configuration (dry run):
#   sudo logrotate -d /etc/logrotate.d/ml-infrastructure
#
# Force rotation (for testing):
#   sudo logrotate -f /etc/logrotate.d/ml-infrastructure
#
# Verbose mode:
#   sudo logrotate -v /etc/logrotate.d/ml-infrastructure
#
# Check status:
#   cat /var/lib/logrotate/status
#
# Manual test of specific log:
#   sudo logrotate -f /etc/logrotate.conf -s /var/lib/logrotate/status
#
###############################################################################
# Best Practices
###############################################################################
#
# 1. Use copytruncate for logs kept open by processes
# 2. Use postrotate with reload/HUP for logs reopened by process
# 3. Set appropriate rotate counts based on log size and retention needs
# 4. Use compress to save disk space
# 5. Use delaycompress to keep most recent log uncompressed (easier analysis)
# 6. Use dateext for easier identification of log files
# 7. Set minsize to avoid rotating empty or tiny logs
# 8. Use sharedscripts to run postrotate once for multiple logs
# 9. Test configuration before deploying (logrotate -d)
# 10. Monitor logrotate execution: grep logrotate /var/log/syslog
#
###############################################################################
