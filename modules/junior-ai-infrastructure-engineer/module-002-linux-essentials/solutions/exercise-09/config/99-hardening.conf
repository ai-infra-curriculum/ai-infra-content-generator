# SSH Hardening Configuration for ML Infrastructure
# Installation: sudo cp 99-hardening.conf /etc/ssh/sshd_config.d/
# Test: sudo sshd -t
# Apply: sudo systemctl reload sshd

###############################################################################
# Authentication Configuration
###############################################################################

# Disable password authentication - force key-based auth only
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no

# Disable root login (use sudo instead)
PermitRootLogin no

# Limit authentication attempts
MaxAuthTries 3
MaxSessions 5

# Disable keyboard-interactive authentication
KbdInteractiveAuthentication no

###############################################################################
# Protocol Configuration
###############################################################################

# Use SSH protocol 2 only (protocol 1 is insecure)
Protocol 2

# Set strict mode to check file permissions
StrictModes yes

# Set login grace time (30 seconds to complete authentication)
LoginGraceTime 30

###############################################################################
# Feature Restrictions
###############################################################################

# Disable X11 forwarding (unless specifically needed for visualization)
X11Forwarding no

# Disable TCP forwarding (enable if needed for tunneling)
# AllowTcpForwarding no
# GatewayPorts no

# Disable agent forwarding
AllowAgentForwarding no

# Disable stream local forwarding
AllowStreamLocalForwarding no

# Disable user environment processing
PermitUserEnvironment no

# Disable compression (can be enabled for slow connections)
Compression no

# Disable tunneling
PermitTunnel no

###############################################################################
# Access Control
###############################################################################

# Limit to specific users (uncomment and customize)
# AllowUsers mluser dataengineer admin
# AllowGroups ml-team data-team

# Deny specific users (if needed)
# DenyUsers guest test

# Limit to specific source IPs/networks (uncomment and customize)
# Match Address 10.0.0.0/8,192.168.0.0/16
#     PasswordAuthentication no

###############################################################################
# Session Configuration
###############################################################################

# Set idle timeout (15 minutes)
# Server sends alive message every 300 seconds (5 minutes)
# If no response after 2 attempts, disconnect (total 10 minutes)
ClientAliveInterval 300
ClientAliveCountMax 2

# Maximum concurrent sessions
MaxSessions 10

# Maximum startups waiting to authenticate
MaxStartups 10:30:60
# Explanation: Start dropping at 10, 30% drop rate, refuse at 60

###############################################################################
# Cryptography Configuration
###############################################################################

# Use strong key exchange algorithms
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256

# Use strong ciphers
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

# Use strong MACs
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256

# Host key algorithms
HostKeyAlgorithms ssh-ed25519,ssh-ed25519-cert-v01@openssh.com,sk-ssh-ed25519@openssh.com,sk-ssh-ed25519-cert-v01@openssh.com,rsa-sha2-512,rsa-sha2-256

###############################################################################
# Logging Configuration
###############################################################################

# Set log level to INFO for detailed logging
LogLevel VERBOSE

# Log public key fingerprints
# (Useful for auditing and incident response)
# LogLevel DEBUG3

###############################################################################
# Banner Configuration
###############################################################################

# Display warning banner before authentication
# Banner /etc/ssh/banner.txt

# Example banner content:
# ┌─────────────────────────────────────────────────────────────────┐
# │                  ML Infrastructure Platform                     │
# │                                                                 │
# │  Authorized access only. All activity is logged and monitored. │
# │  Unauthorized access is prohibited and may be prosecuted.      │
# └─────────────────────────────────────────────────────────────────┘

###############################################################################
# SFTP Configuration
###############################################################################

# SFTP subsystem (if file transfer needed)
Subsystem sftp /usr/lib/openssh/sftp-server

# Restrict SFTP to specific directory (chroot)
# Match Group sftponly
#     ChrootDirectory /home/%u
#     ForceCommand internal-sftp
#     AllowTcpForwarding no
#     X11Forwarding no

###############################################################################
# Per-Host/Per-User Overrides
###############################################################################

# ML training nodes might need different settings
# Match Host gpu-node-*
#     X11Forwarding yes
#     AllowTcpForwarding yes

# Data engineers might need port forwarding for Jupyter
# Match User dataengineer
#     AllowTcpForwarding yes
#     PermitOpen localhost:8888

###############################################################################
# Security Best Practices Reference
###############################################################################

# 1. Key Management:
#    - Use ED25519 keys (ssh-keygen -t ed25519)
#    - Protect private keys with passphrases
#    - Rotate keys periodically (every 6-12 months)
#    - Use different keys for different environments

# 2. Monitoring:
#    - Monitor /var/log/auth.log for failed attempts
#    - Set up fail2ban to block brute force attacks
#    - Alert on successful root logins (should not happen)
#    - Track public key changes

# 3. Audit:
#    - Regularly review authorized_keys files
#    - Remove keys for departed users
#    - Document all key pairs and their purposes
#    - Audit SSH configuration changes

# 4. Network Security:
#    - Use firewall (UFW/iptables) to limit SSH sources
#    - Consider moving SSH to non-standard port (security through obscurity)
#    - Use VPN or bastion hosts for production access
#    - Enable rate limiting (ufw limit 22/tcp)

# 5. Multi-Factor Authentication:
#    - Consider adding MFA (Google Authenticator, Duo)
#    - PAM configuration for additional authentication
#    - FIDO2/U2F hardware keys

###############################################################################
# Testing Commands
###############################################################################

# Test configuration syntax:
# sudo sshd -t

# Test configuration with detailed output:
# sudo sshd -T

# Test specific user configuration:
# sudo sshd -T -C user=mluser,host=gpu-node-1,addr=192.168.1.100

# Reload SSH daemon:
# sudo systemctl reload sshd

# Check SSH daemon status:
# sudo systemctl status sshd

# View SSH logs:
# sudo tail -f /var/log/auth.log | grep sshd

# Test connection with verbose output:
# ssh -vv user@host

# Test key authentication specifically:
# ssh -vv -o PreferredAuthentications=publickey user@host

###############################################################################
# Emergency Access
###############################################################################

# IMPORTANT: Before applying this configuration remotely:
# 1. Test on a local session first
# 2. Keep an active SSH session open while testing
# 3. Have console access available (IPMI, cloud console, physical access)
# 4. Test new connection in separate window before closing existing session
# 5. If locked out, revert via console: sudo mv /etc/ssh/sshd_config.backup /etc/ssh/sshd_config

# Emergency rollback (if you get locked out):
# 1. Access via console (physical or cloud)
# 2. sudo rm /etc/ssh/sshd_config.d/99-hardening.conf
# 3. sudo systemctl reload sshd
# 4. Restore access and debug configuration

###############################################################################
# Compliance Mappings
###############################################################################

# CIS Benchmark Compliance:
# - 5.2.1: PermitRootLogin set to no
# - 5.2.2: PermitEmptyPasswords set to no
# - 5.2.3: Protocol set to 2
# - 5.2.4: Strong ciphers configured
# - 5.2.5: Strong MACs configured
# - 5.2.6: Strong key exchange algorithms
# - 5.2.7: ClientAliveInterval and ClientAliveCountMax set
# - 5.2.8: PasswordAuthentication set to no
# - 5.2.9: MaxAuthTries set to 3 or less

# PCI-DSS Compliance:
# - 2.2.4: Configure only necessary services
# - 8.2.3: Strong password policy (key-based auth is stronger)
# - 8.2.4: Change passwords every 90 days (rotate keys)
# - 8.5: Do not share IDs and passwords

# NIST 800-53 Controls:
# - AC-17: Remote Access
# - IA-2: Identification and Authentication
# - SC-13: Cryptographic Protection

###############################################################################
# Additional Resources
###############################################################################

# Mozilla SSH Security Guidelines:
# https://infosec.mozilla.org/guidelines/openssh

# SSH Audit Tool:
# https://github.com/arthepsy/ssh-audit
# Usage: ssh-audit localhost

# Hardening Guide:
# https://www.ssh.com/academy/ssh/sshd_config

# CIS Benchmarks:
# https://www.cisecurity.org/cis-benchmarks
