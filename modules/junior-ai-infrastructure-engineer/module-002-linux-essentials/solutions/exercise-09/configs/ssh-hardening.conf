#
# Hardened SSH Server Configuration
#
# Place this file in /etc/ssh/sshd_config.d/99-hardening.conf
# Tested on OpenSSH 8.0+
#
# Apply with:
#   sudo sshd -t                    # Test configuration
#   sudo systemctl reload sshd      # Apply if valid
#
# Security Level: High
# Use Case: ML Infrastructure / Production Servers
#

# ============================================================================
# AUTHENTICATION
# ============================================================================

# Disable password authentication completely (key-based only)
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no

# Allow public key authentication
PubkeyAuthentication yes

# Disable unused authentication methods
KerberosAuthentication no
GSSAPIAuthentication no
HostbasedAuthentication no

# ============================================================================
# ACCESS CONTROL
# ============================================================================

# Disable root login entirely
# Root access should use sudo from regular accounts
PermitRootLogin no

# Limit authentication attempts
MaxAuthTries 3
MaxSessions 5

# Set login grace time (time to authenticate)
LoginGraceTime 30

# Allow only specific users (uncomment and customize)
# AllowUsers mluser dataengineer devops
# AllowGroups ml-team data-team

# Deny specific users (if needed)
# DenyUsers root guest

# ============================================================================
# PROTOCOL AND ENCRYPTION
# ============================================================================

# Use only SSH protocol 2 (protocol 1 is insecure)
Protocol 2

# Specify strong key exchange algorithms
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha256

# Specify strong ciphers
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

# Specify strong MAC algorithms
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256

# Use only strong host key algorithms
HostKeyAlgorithms ssh-ed25519,ssh-ed25519-cert-v01@openssh.com,sk-ssh-ed25519@openssh.com,sk-ssh-ed25519-cert-v01@openssh.com,rsa-sha2-512,rsa-sha2-512-cert-v01@openssh.com,rsa-sha2-256,rsa-sha2-256-cert-v01@openssh.com

# ============================================================================
# SECURITY FEATURES
# ============================================================================

# Enable strict mode (check file permissions)
StrictModes yes

# Disable X11 forwarding (unless needed for GUI apps)
X11Forwarding no

# Disable TCP forwarding (uncomment if port forwarding not needed)
# AllowTcpForwarding no
# AllowStreamLocalForwarding no
# GatewayPorts no

# Disable agent forwarding (security risk)
AllowAgentForwarding no

# Disable user environment variables
PermitUserEnvironment no

# Print last login information
PrintLastLog yes

# ============================================================================
# SESSION MANAGEMENT
# ============================================================================

# Set idle timeout (15 minutes)
# Server sends keepalive every 5 minutes
# Disconnect after 3 failed keepalive responses
ClientAliveInterval 300
ClientAliveCountMax 2

# TCP keepalive (detects dead connections)
TCPKeepAlive yes

# ============================================================================
# LOGGING
# ============================================================================

# Enable detailed logging for security auditing
LogLevel VERBOSE
SyslogFacility AUTH

# ============================================================================
# PERFORMANCE
# ============================================================================

# Disable compression (slight security improvement)
Compression no

# Use privilege separation for better security
UsePrivilegeSeparation sandbox

# DNS lookups can be slow and are rarely needed
UseDNS no

# ============================================================================
# BANNER AND MESSAGES
# ============================================================================

# Display a warning banner before authentication
# Banner /etc/ssh/banner.txt

# Don't send version information
DebianBanner no

# ============================================================================
# ADDITIONAL HARDENING (optional)
# ============================================================================

# Require specific source addresses (uncomment and customize)
# Match Address 192.168.1.0/24,10.0.0.0/8
#     PasswordAuthentication yes
#     PubkeyAuthentication yes

# Separate configuration for automated systems (no password prompt)
# Match User automation
#     PasswordAuthentication no
#     AuthenticationMethods publickey
#     AllowTcpForwarding no

# Jump host / bastion configuration
# Match User bastion
#     AllowTcpForwarding yes
#     GatewayPorts clientspecified
#     PermitOpen *:22 *:3389

# GPU nodes (allow port forwarding for Jupyter)
# Match User mluser
#     AllowTcpForwarding local
#     PermitOpen localhost:8888 localhost:8000

# ============================================================================
# NOTES
# ============================================================================
#
# After making changes:
#   1. Test: sudo sshd -t
#   2. Reload: sudo systemctl reload sshd
#   3. DON'T close your current SSH session until you've tested a new one
#   4. Keep a backup: sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
#
# Generate strong keys:
#   ssh-keygen -t ed25519 -C "ml-platform-$(date +%Y%m%d)"
#
# Monitor failed login attempts:
#   sudo grep "Failed password" /var/log/auth.log | tail -20
#   sudo grep "Accepted publickey" /var/log/auth.log | tail -20
#
# Install fail2ban for automatic blocking of brute force attempts:
#   sudo apt-get install fail2ban
#   sudo systemctl enable fail2ban
#
