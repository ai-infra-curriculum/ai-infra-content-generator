#!/bin/bash
#
# Git Commit-Msg Hook for Production ML System
# Based on Module 003 Exercise 07 advanced Git techniques
#
# Installation:
#   cp hooks/commit-msg .git/hooks/commit-msg
#   chmod +x .git/hooks/commit-msg
#
# This hook validates commit messages follow conventional commit format

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits and revert commits
if echo "$COMMIT_MSG" | grep -qE "^Merge|^Revert"; then
    exit 0
fi

# Get first line
FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)

echo -e "${BLUE}üìù Validating commit message...${NC}\n"

ERRORS=0

# ============================================================================
# 1. Conventional Commit Format
# ============================================================================
echo -e "${BLUE}[1/4]${NC} Checking conventional commit format..."

# Pattern: type(scope): description
# type is required, scope is optional
PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert|model)(\(.+\))?: .+"

if [[ ! $FIRST_LINE =~ $PATTERN ]]; then
    echo -e "${RED}‚úó Commit message doesn't follow conventional format${NC}\n"
    echo -e "${YELLOW}Current message:${NC}"
    echo -e "  $FIRST_LINE"
    echo ""
    echo -e "${YELLOW}Required format:${NC}"
    echo -e "  type(scope): description"
    echo ""
    echo -e "${BLUE}Valid types:${NC}"
    echo -e "  ‚Ä¢ feat:     New feature"
    echo -e "  ‚Ä¢ fix:      Bug fix"
    echo -e "  ‚Ä¢ docs:     Documentation changes"
    echo -e "  ‚Ä¢ style:    Code style changes (formatting, etc.)"
    echo -e "  ‚Ä¢ refactor: Code refactoring"
    echo -e "  ‚Ä¢ test:     Adding or updating tests"
    echo -e "  ‚Ä¢ chore:    Maintenance tasks"
    echo -e "  ‚Ä¢ perf:     Performance improvements"
    echo -e "  ‚Ä¢ ci:       CI/CD changes"
    echo -e "  ‚Ä¢ build:    Build system changes"
    echo -e "  ‚Ä¢ revert:   Revert a previous commit"
    echo -e "  ‚Ä¢ model:    ML model updates"
    echo ""
    echo -e "${BLUE}Examples:${NC}"
    echo -e "  ‚úì feat(api): add health check endpoint"
    echo -e "  ‚úì fix(model): correct preprocessing bug"
    echo -e "  ‚úì docs: update deployment guide"
    echo -e "  ‚úì model(bert): release v2.1.0 with attention"
    echo -e "  ‚úó Added new feature (missing type)"
    echo -e "  ‚úó feat: (missing description)"
    echo ""
    ERRORS=$((ERRORS + 1))
else
    # Extract type and scope
    TYPE=$(echo "$FIRST_LINE" | sed -n 's/^\([a-z]\+\).*/\1/p')
    if echo "$FIRST_LINE" | grep -q "("; then
        SCOPE=$(echo "$FIRST_LINE" | sed -n 's/^[a-z]\+(\([^)]\+\)).*/\1/p')
        echo -e "${GREEN}‚úì Type: $TYPE, Scope: $SCOPE${NC}\n"
    else
        echo -e "${GREEN}‚úì Type: $TYPE${NC}\n"
    fi
fi

# ============================================================================
# 2. First Line Length
# ============================================================================
echo -e "${BLUE}[2/4]${NC} Checking first line length..."

MAX_LENGTH=72
FIRST_LINE_LENGTH=${#FIRST_LINE}

if [ $FIRST_LINE_LENGTH -gt $MAX_LENGTH ]; then
    echo -e "${RED}‚úó First line too long: $FIRST_LINE_LENGTH characters (max $MAX_LENGTH)${NC}\n"
    echo -e "${YELLOW}Current: $FIRST_LINE${NC}\n"
    echo -e "${YELLOW}Try to keep it under $MAX_LENGTH characters${NC}\n"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì First line length: $FIRST_LINE_LENGTH characters${NC}\n"
fi

# ============================================================================
# 3. Description Check
# ============================================================================
echo -e "${BLUE}[3/4]${NC} Checking description..."

# Get description (part after colon)
if echo "$FIRST_LINE" | grep -q ":"; then
    DESCRIPTION=$(echo "$FIRST_LINE" | sed 's/^[^:]*: *//')
    DESC_LENGTH=${#DESCRIPTION}

    # Description should be at least 10 characters
    if [ $DESC_LENGTH -lt 10 ]; then
        echo -e "${RED}‚úó Description too short: $DESC_LENGTH characters (min 10)${NC}\n"
        echo -e "${YELLOW}Provide a meaningful description of the change${NC}\n"
        ERRORS=$((ERRORS + 1))
    else
        # Check if description starts with capital letter
        if [[ ! $DESCRIPTION =~ ^[A-Z] ]]; then
            echo -e "${YELLOW}‚ö† Description should start with a lowercase letter${NC}"
            echo -e "${YELLOW}Example: 'feat(api): add endpoint' not 'feat(api): Add endpoint'${NC}\n"
            # Don't fail, just warn
        fi

        # Check if description ends with period
        if [[ $DESCRIPTION =~ \.$ ]]; then
            echo -e "${YELLOW}‚ö† Description shouldn't end with a period${NC}\n"
            # Don't fail, just warn
        fi

        echo -e "${GREEN}‚úì Description length: $DESC_LENGTH characters${NC}\n"
    fi
fi

# ============================================================================
# 4. Body Format
# ============================================================================
echo -e "${BLUE}[4/4]${NC} Checking body format..."

# Check if there's a blank line after the first line
LINE_COUNT=$(echo "$COMMIT_MSG" | wc -l)

if [ $LINE_COUNT -gt 1 ]; then
    SECOND_LINE=$(echo "$COMMIT_MSG" | sed -n '2p')

    if [ -n "$SECOND_LINE" ]; then
        echo -e "${YELLOW}‚ö† Second line should be blank${NC}"
        echo -e "${YELLOW}Format:${NC}"
        echo -e "  Line 1: type(scope): description"
        echo -e "  Line 2: <blank line>"
        echo -e "  Line 3+: detailed description"
        echo ""
        # Don't fail, just warn
    else
        echo -e "${GREEN}‚úì Proper blank line after first line${NC}\n"
    fi
else
    echo -e "${GREEN}‚úì Single line commit (no body)${NC}\n"
fi

# ============================================================================
# 5. Breaking Changes
# ============================================================================
# Check for BREAKING CHANGE in commit body
if echo "$COMMIT_MSG" | grep -q "BREAKING CHANGE:"; then
    echo -e "${YELLOW}‚ö† BREAKING CHANGE detected${NC}"
    echo -e "${YELLOW}Make sure to:${NC}"
    echo -e "  ‚Ä¢ Update major version"
    echo -e "  ‚Ä¢ Document the breaking change"
    echo -e "  ‚Ä¢ Update migration guide"
    echo ""
fi

# ============================================================================
# Summary
# ============================================================================
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}================================${NC}"
    echo -e "${RED}‚ùå Commit message validation FAILED${NC}"
    echo -e "${RED}================================${NC}"
    echo -e "${RED}Found $ERRORS error(s) in commit message${NC}\n"

    echo -e "${YELLOW}Edit your commit message with:${NC}"
    echo -e "  git commit --amend"
    echo ""

    exit 1
else
    echo -e "${GREEN}================================${NC}"
    echo -e "${GREEN}‚úÖ Commit message is valid!${NC}"
    echo -e "${GREEN}================================${NC}\n"
    exit 0
fi
