#!/bin/bash
#
# Git Pre-Commit Hook for Production ML System
# Based on Module 003 Exercise 07 advanced Git techniques
#
# Installation:
#   cp hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# This hook runs automatically before each commit and performs:
# 1. Python syntax validation
# 2. Security checks (secrets, debug statements)
# 3. Code quality checks
# 4. File size limits
# 5. Kubernetes manifest validation

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç Running pre-commit checks...${NC}\n"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
PYTHON_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' || true)
YAML_FILES=$(echo "$STAGED_FILES" | grep -E '\.ya?ml$' || true)
SHELL_FILES=$(echo "$STAGED_FILES" | grep -E '\.sh$' || true)

ERRORS=0

# ============================================================================
# 1. Python Syntax Check
# ============================================================================
if [ -n "$PYTHON_FILES" ]; then
    echo -e "${BLUE}[1/8]${NC} Checking Python syntax..."

    for file in $PYTHON_FILES; do
        if [ -f "$file" ]; then
            python3 -m py_compile "$file" 2>/dev/null
            if [ $? -ne 0 ]; then
                echo -e "${RED}‚úó Syntax error in $file${NC}"
                ERRORS=$((ERRORS + 1))
            fi
        fi
    done

    if [ $ERRORS -eq 0 ]; then
        echo -e "${GREEN}‚úì All Python files have valid syntax${NC}\n"
    fi
else
    echo -e "${BLUE}[1/8]${NC} No Python files to check\n"
fi

# ============================================================================
# 2. Debug Statement Detection
# ============================================================================
if [ -n "$PYTHON_FILES" ]; then
    echo -e "${BLUE}[2/8]${NC} Checking for debug statements..."

    DEBUG_FOUND=0
    for file in $PYTHON_FILES; do
        if [ -f "$file" ]; then
            # Check for common debug patterns
            if grep -n -E "(print\(|pdb\.set_trace|breakpoint\(|import pdb)" "$file"; then
                echo -e "${YELLOW}‚ö† Debug statement found in $file${NC}"
                DEBUG_FOUND=1
            fi
        fi
    done

    if [ $DEBUG_FOUND -eq 1 ]; then
        echo -e "${YELLOW}‚ö† Warning: Debug statements found. Remove before committing to production.${NC}\n"
        # Don't fail, just warn
    else
        echo -e "${GREEN}‚úì No debug statements found${NC}\n"
    fi
else
    echo -e "${BLUE}[2/8]${NC} No Python files to check\n"
fi

# ============================================================================
# 3. Secret Detection
# ============================================================================
echo -e "${BLUE}[3/8]${NC} Checking for hardcoded secrets..."

SECRET_PATTERNS=(
    "password\s*=\s*['\"][^'\"]{8,}"
    "api[_-]?key\s*=\s*['\"][^'\"]{8,}"
    "secret\s*=\s*['\"][^'\"]{8,}"
    "token\s*=\s*['\"][^'\"]{8,}"
    "aws_secret_access_key"
    "private_key"
    "['\"]sk-[A-Za-z0-9]{32,}['\"]"  # OpenAI key pattern
    "-----BEGIN PRIVATE KEY-----"
    "-----BEGIN RSA PRIVATE KEY-----"
)

SECRETS_FOUND=0
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -qi -E "$pattern" "$file"; then
                echo -e "${RED}‚úó Potential secret found in $file${NC}"
                grep -n -i -E "$pattern" "$file" | head -3
                SECRETS_FOUND=1
                ERRORS=$((ERRORS + 1))
            fi
        done
    fi
done

if [ $SECRETS_FOUND -eq 0 ]; then
    echo -e "${GREEN}‚úì No hardcoded secrets detected${NC}\n"
else
    echo -e "${RED}‚úó CRITICAL: Secrets detected! Do not commit sensitive data.${NC}"
    echo -e "${YELLOW}Use environment variables or secret management tools (Kubernetes Secrets, Vault)${NC}\n"
fi

# ============================================================================
# 4. File Size Check
# ============================================================================
echo -e "${BLUE}[4/8]${NC} Checking file sizes..."

MAX_FILE_SIZE=$((5 * 1024 * 1024))  # 5MB
LARGE_FILES_FOUND=0

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        FILE_SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)

        if [ $FILE_SIZE -gt $MAX_FILE_SIZE ]; then
            SIZE_MB=$(echo "scale=2; $FILE_SIZE / 1024 / 1024" | bc)
            echo -e "${RED}‚úó Large file: $file (${SIZE_MB}MB)${NC}"
            LARGE_FILES_FOUND=1
        fi
    fi
done

if [ $LARGE_FILES_FOUND -eq 1 ]; then
    echo -e "${YELLOW}‚ö† Large files detected. Consider using Git LFS:${NC}"
    echo -e "${YELLOW}  git lfs track \"*.pth\"${NC}"
    echo -e "${YELLOW}  git lfs track \"*.h5\"${NC}\n"
    # Don't fail, just warn
else
    echo -e "${GREEN}‚úì All files within size limits${NC}\n"
fi

# ============================================================================
# 5. YAML Validation
# ============================================================================
if [ -n "$YAML_FILES" ]; then
    echo -e "${BLUE}[5/8]${NC} Validating YAML files..."

    YAML_ERRORS=0
    for file in $YAML_FILES; do
        if [ -f "$file" ]; then
            # Try to parse YAML with Python
            python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null
            if [ $? -ne 0 ]; then
                echo -e "${RED}‚úó Invalid YAML in $file${NC}"
                YAML_ERRORS=$((YAML_ERRORS + 1))
                ERRORS=$((ERRORS + 1))
            fi
        fi
    done

    if [ $YAML_ERRORS -eq 0 ]; then
        echo -e "${GREEN}‚úì All YAML files are valid${NC}\n"
    fi
else
    echo -e "${BLUE}[5/8]${NC} No YAML files to check\n"
fi

# ============================================================================
# 6. Kubernetes Manifest Validation
# ============================================================================
K8S_FILES=$(echo "$YAML_FILES" | grep -E 'kubernetes/.*\.ya?ml$' || true)

if [ -n "$K8S_FILES" ]; then
    echo -e "${BLUE}[6/8]${NC} Validating Kubernetes manifests..."

    K8S_ERRORS=0
    for file in $K8S_FILES; do
        if [ -f "$file" ]; then
            # Dry-run validation (if kubectl is available)
            if command -v kubectl &> /dev/null; then
                kubectl apply --dry-run=client -f "$file" &>/dev/null
                if [ $? -ne 0 ]; then
                    echo -e "${RED}‚úó Invalid Kubernetes manifest: $file${NC}"
                    K8S_ERRORS=$((K8S_ERRORS + 1))
                fi
            fi
        fi
    done

    if [ $K8S_ERRORS -eq 0 ]; then
        echo -e "${GREEN}‚úì All Kubernetes manifests are valid${NC}\n"
    else
        echo -e "${YELLOW}‚ö† Some Kubernetes manifests have validation warnings${NC}\n"
        # Don't fail on K8s validation
    fi
else
    echo -e "${BLUE}[6/8]${NC} No Kubernetes manifests to check\n"
fi

# ============================================================================
# 7. Shell Script Validation
# ============================================================================
if [ -n "$SHELL_FILES" ]; then
    echo -e "${BLUE}[7/8]${NC} Validating shell scripts..."

    SHELL_ERRORS=0
    for file in $SHELL_FILES; do
        if [ -f "$file" ]; then
            # Check if script is executable
            if [ ! -x "$file" ]; then
                echo -e "${YELLOW}‚ö† Shell script not executable: $file${NC}"
            fi

            # Shellcheck validation (if available)
            if command -v shellcheck &> /dev/null; then
                shellcheck -x "$file" 2>&1 | head -20
                if [ ${PIPESTATUS[0]} -ne 0 ]; then
                    SHELL_ERRORS=$((SHELL_ERRORS + 1))
                fi
            fi
        fi
    done

    if [ $SHELL_ERRORS -eq 0 ]; then
        echo -e "${GREEN}‚úì All shell scripts passed validation${NC}\n"
    else
        echo -e "${YELLOW}‚ö† Some shell scripts have warnings (not blocking)${NC}\n"
    fi
else
    echo -e "${BLUE}[7/8]${NC} No shell scripts to check\n"
fi

# ============================================================================
# 8. Commit Message Check
# ============================================================================
echo -e "${BLUE}[8/8]${NC} Pre-commit checks complete!\n"

# ============================================================================
# Summary
# ============================================================================
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}================================${NC}"
    echo -e "${RED}‚ùå Pre-commit checks FAILED${NC}"
    echo -e "${RED}================================${NC}"
    echo -e "${RED}Found $ERRORS critical error(s)${NC}"
    echo -e "${YELLOW}Please fix the errors above and try again.${NC}\n"

    echo -e "${BLUE}Common fixes:${NC}"
    echo -e "  ‚Ä¢ Remove hardcoded secrets ‚Üí use environment variables"
    echo -e "  ‚Ä¢ Fix Python syntax errors"
    echo -e "  ‚Ä¢ Fix YAML syntax errors"
    echo -e "  ‚Ä¢ Use Git LFS for large files"
    echo ""

    exit 1
else
    echo -e "${GREEN}================================${NC}"
    echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
    echo -e "${GREEN}================================${NC}\n"

    echo -e "${BLUE}Committing staged files...${NC}\n"
    exit 0
fi
